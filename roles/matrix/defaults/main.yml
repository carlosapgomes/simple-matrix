---
# Required variables are validated in tasks/validate.yml

matrix_user: matrix
matrix_home: /opt/matrix
matrix_uid: 987
matrix_gid: 987
matrix_shell: /usr/sbin/nologin

matrix_data_dir: "{{ matrix_home }}/data"
matrix_backup_dir: "{{ matrix_home }}/backups"
matrix_subuid_start: 100000
matrix_subuid_range: 65536

# Rootless user namespace mapping for postgres user (uid/gid 999 in container)
postgres_container_uid: 999
postgres_container_gid: 999
postgres_host_uid: "{{ (matrix_subuid_start | int) + (postgres_container_uid | int) - 1 }}"
postgres_host_gid: "{{ (matrix_subuid_start | int) + (postgres_container_gid | int) - 1 }}"

# Rootless user namespace mapping for synapse user (uid/gid 991 in container)
synapse_container_uid: 991
synapse_container_gid: 991
synapse_host_uid: "{{ (matrix_subuid_start | int) + (synapse_container_uid | int) - 1 }}"
synapse_host_gid: "{{ (matrix_subuid_start | int) + (synapse_container_gid | int) - 1 }}"

# Docker / Compose
docker_rootless: true
docker_compose_project: matrix
docker_rootlesskit_net_driver: slirp4netns
docker_rootlesskit_port_driver: builtin
docker_packages_state: latest
docker_min_server_version: "28.0.1"
matrix_network_internal: false

synapse_image: docker.io/matrixdotorg/synapse:latest
synapse_container_user: "{{ synapse_container_uid }}:{{ synapse_container_gid }}"
postgres_image: docker.io/postgres:16
nginx_image: docker.io/nginx:stable
synapse_admin_image: docker.io/etkecc/synapse-admin:latest
synapse_admin_upstream_port: 8080
synapse_admin_restrict_baseurl: "https://{{ matrix_fqdn }}"
cloudflared_image: docker.io/cloudflare/cloudflared:latest
backup_image: docker.io/alpine:3.19
backup_image_local: matrix-backup:latest

# Matrix web clients
matrix_web_default_client: cinny
matrix_web_secondary_client: ""
matrix_web_secondary_path: /chat2

# Cinny deployment mode
# By default, use the upstream prebuilt image for reliability.
cinny_build_from_source: false
cinny_image_prebuilt: ghcr.io/cinnyapp/cinny:latest
cinny_image_local: cinny:local
cinny_image: "{{ cinny_image_local if (cinny_build_from_source | bool) else cinny_image_prebuilt }}"

cinny_repo: https://github.com/cinnyapp/cinny.git
cinny_version: v4.10.2
cinny_build_dir: "{{ matrix_home }}/cinny/src"

# FluffyChat web deployment
fluffychat_image: ghcr.io/etkecc/fluffychat-web:latest
fluffychat_upstream_port: 8080
fluffychat_config_container_path: /usr/share/nginx/html/config.json
fluffychat_config_json:
  defaultHomeserver: "https://{{ matrix_fqdn }}"
  allowCustomHomeservers: false

postgres_db: synapse
postgres_user: synapse
postgres_initdb_args: "--encoding=UTF8 --locale=C"

backup_time: "03:00"
backup_timezone: "UTC"

firewall_backend: ufw
firewall_allow_ssh: true
firewall_ssh_port: 22

# Derived
matrix_synapse_server_name: "{{ matrix_fqdn }}"
matrix_public_baseurl: "https://{{ matrix_fqdn }}/"

# Registration policy
synapse_enable_registration: false
synapse_enable_registration_without_verification: false

# Cinny login UX
cinny_hide_register_prompt: "{{ not (synapse_enable_registration | bool) }}"
