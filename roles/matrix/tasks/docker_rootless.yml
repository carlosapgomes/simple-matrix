---
- name: Enable linger for matrix user
  ansible.builtin.command: "loginctl enable-linger {{ matrix_user }}"
  args:
    creates: "/var/lib/systemd/linger/{{ matrix_user }}"

- name: Ensure subuid entry for matrix user
  ansible.builtin.lineinfile:
    path: /etc/subuid
    regexp: "^{{ matrix_user }}:"
    line: "{{ matrix_user }}:{{ matrix_subuid_start }}:{{ matrix_subuid_range }}"
    create: true
    mode: "0644"

- name: Ensure subgid entry for matrix user
  ansible.builtin.lineinfile:
    path: /etc/subgid
    regexp: "^{{ matrix_user }}:"
    line: "{{ matrix_user }}:{{ matrix_subuid_start }}:{{ matrix_subuid_range }}"
    create: true
    mode: "0644"

- name: Ensure rootless Docker is installed for matrix user
  ansible.builtin.command: dockerd-rootless-setuptool.sh install
  register: rootless_setup
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"
  args:
    creates: "{{ matrix_home }}/.config/systemd/user/docker.service"

- name: Ensure rootless Docker systemd override directory exists
  ansible.builtin.file:
    path: "{{ matrix_home }}/.config/systemd/user/docker.service.d"
    state: directory
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0755"

- name: Configure rootless Docker networking drivers
  ansible.builtin.template:
    src: docker-rootless.override.conf.j2
    dest: "{{ matrix_home }}/.config/systemd/user/docker.service.d/override.conf"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
  register: rootless_override

- name: Reload rootless Docker user service definitions
  ansible.builtin.command: systemctl --user daemon-reload
  changed_when: false
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"
  when: rootless_override is changed

- name: Enable and start rootless Docker service
  ansible.builtin.systemd:
    name: docker.service
    state: started
    enabled: true
    scope: user
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Restart rootless Docker service after reinstall
  ansible.builtin.systemd:
    name: docker.service
    state: restarted
    enabled: true
    scope: user
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"
  when: rootless_setup is changed or rootless_override is changed

- name: Get rootless Docker server version
  ansible.builtin.command: >-
    docker version --format '{{ '{{' }}.Server.Version{{ '}}' }}'
  register: docker_server_version
  changed_when: false
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Assert rootless Docker server version is supported
  ansible.builtin.assert:
    that:
      - docker_server_version.stdout | trim is version(docker_min_server_version, '>=')
    fail_msg: >-
      Docker server version {{ docker_server_version.stdout | trim }} is below
      required minimum {{ docker_min_server_version }} for stable rootless port
      publishing.

- name: Capture rootlesskit process arguments
  ansible.builtin.command: pgrep -u {{ matrix_uid }} -af rootlesskit
  register: rootlesskit_ps
  failed_when: false
  changed_when: false

- name: Assert rootlesskit uses configured network and port drivers
  ansible.builtin.assert:
    that:
      - rootlesskit_ps.rc == 0
      - (rootlesskit_ps.stdout | regex_search('--net=' ~ docker_rootlesskit_net_driver ~ '(\\s|$)')) is not none
      - (rootlesskit_ps.stdout | regex_search('--port-driver=' ~ docker_rootlesskit_port_driver ~ '(\\s|$)')) is not none
    fail_msg: >-
      RootlessKit drivers mismatch. Expected --net={{ docker_rootlesskit_net_driver }}
      and --port-driver={{ docker_rootlesskit_port_driver }} but got:
      {{ rootlesskit_ps.stdout | default('not running') }}.
