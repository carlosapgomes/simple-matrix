---
- name: Validate required variables are set
  ansible.builtin.assert:
    that:
      - lookup('ansible.builtin.vars', item, default='') | string | length > 0
    fail_msg: "Required variable '{{ item }}' is missing or empty."
  loop: "{{ matrix_required_vars }}"

- name: Validate retention values
  ansible.builtin.assert:
    that:
      - matrix_retention_days | int > 0
      - backup_retention_days | int > 0
    fail_msg: "Retention values must be positive integers."

- name: Validate registration policy
  ansible.builtin.assert:
    that:
      - not (synapse_enable_registration_without_verification | bool) or (synapse_enable_registration | bool)
    fail_msg: >-
      synapse_enable_registration_without_verification=true requires
      synapse_enable_registration=true.

- name: Validate firewall backend
  ansible.builtin.assert:
    that:
      - firewall_backend in ['ufw', 'nftables']
    fail_msg: "firewall_backend must be 'ufw' or 'nftables'."

- name: Validate Docker package state
  ansible.builtin.assert:
    that:
      - docker_packages_state in ['present', 'latest']
    fail_msg: "docker_packages_state must be 'present' or 'latest'."

- name: Validate network mode compatibility
  ansible.builtin.assert:
    that:
      - not (matrix_network_internal | bool)
    fail_msg: >-
      matrix_network_internal=true is incompatible with this role because nginx
      must publish host port 8080 for local health checks and Cloudflare tunnel
      forwarding.

- name: Validate Synapse Admin upstream port
  ansible.builtin.assert:
    that:
      - synapse_admin_upstream_port | int > 0
      - synapse_admin_upstream_port | int < 65536
    fail_msg: "synapse_admin_upstream_port must be between 1 and 65535."
