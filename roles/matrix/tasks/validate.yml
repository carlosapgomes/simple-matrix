---
- name: Validate required variables are set
  ansible.builtin.assert:
    that:
      - lookup('ansible.builtin.vars', item, default='') | string | length > 0
    fail_msg: "Required variable '{{ item }}' is missing or empty."
  loop: "{{ matrix_required_vars }}"

- name: Validate retention values
  ansible.builtin.assert:
    that:
      - matrix_retention_days | int > 0
      - backup_retention_days | int > 0
    fail_msg: "Retention values must be positive integers."

- name: Validate registration policy
  ansible.builtin.assert:
    that:
      - not (synapse_enable_registration_without_verification | bool) or (synapse_enable_registration | bool)
    fail_msg: >-
      synapse_enable_registration_without_verification=true requires
      synapse_enable_registration=true.

- name: Validate firewall backend
  ansible.builtin.assert:
    that:
      - firewall_backend in ['ufw', 'nftables']
    fail_msg: "firewall_backend must be 'ufw' or 'nftables'."

- name: Validate Docker package state
  ansible.builtin.assert:
    that:
      - docker_packages_state in ['present', 'latest']
    fail_msg: "docker_packages_state must be 'present' or 'latest'."

- name: Validate network mode compatibility
  ansible.builtin.assert:
    that:
      - not (matrix_network_internal | bool)
    fail_msg: >-
      matrix_network_internal=true is incompatible with this role because nginx
      must publish host port 8080 for local health checks and Cloudflare tunnel
      forwarding.

- name: Normalize web client routing settings
  ansible.builtin.set_fact:
    matrix_web_default_client_normalized: "{{ matrix_web_default_client | lower | trim }}"
    matrix_web_secondary_client_normalized: "{{ matrix_web_secondary_client | default('', true) | lower | trim }}"
    matrix_web_secondary_path_normalized: "{{ matrix_web_secondary_path | trim }}"

- name: Validate default web client
  ansible.builtin.assert:
    that:
      - matrix_web_default_client_normalized in ['cinny', 'element_classic']
    fail_msg: "matrix_web_default_client must be 'cinny' or 'element_classic'."

- name: Validate secondary web client
  ansible.builtin.assert:
    that:
      - matrix_web_secondary_client_normalized | length == 0 or matrix_web_secondary_client_normalized in ['cinny', 'element_classic']
      - matrix_web_secondary_client_normalized | length == 0 or matrix_web_secondary_client_normalized != matrix_web_default_client_normalized
    fail_msg: >-
      matrix_web_secondary_client must be empty, 'cinny', or 'element_classic',
      and cannot match matrix_web_default_client.

- name: Validate secondary web client path
  ansible.builtin.assert:
    that:
      - matrix_web_secondary_path_normalized.startswith('/')
      - matrix_web_secondary_path_normalized != '/'
      - not matrix_web_secondary_path_normalized.endswith('/')
      - matrix_web_secondary_path_normalized is match('^/[A-Za-z0-9._~!$&()*+,;=:@%/-]+$')
    fail_msg: >-
      matrix_web_secondary_path must start with '/', must not be '/', and must not
      end with '/'. Example: /chat2
  when: matrix_web_secondary_client_normalized | length > 0

- name: Validate secondary path does not overlap Matrix reserved routes
  ansible.builtin.assert:
    that:
      - not matrix_web_secondary_path_normalized.startswith('/_matrix')
      - not matrix_web_secondary_path_normalized.startswith('/_synapse')
      - not (matrix_web_secondary_path_normalized == '/admin' or matrix_web_secondary_path_normalized.startswith('/admin/'))
      - not matrix_web_secondary_path_normalized.startswith('/.well-known')
    fail_msg: >-
      matrix_web_secondary_path overlaps a reserved route
      (/_matrix, /_synapse, /admin, /.well-known).
  when: matrix_web_secondary_client_normalized | length > 0

- name: Validate custom assets URL path
  ansible.builtin.assert:
    that:
      - matrix_web_assets_url_path.startswith('/')
      - matrix_web_assets_url_path != '/'
      - not matrix_web_assets_url_path.endswith('/')
      - matrix_web_assets_url_path is match('^/[A-Za-z0-9._~!$&()*+,;=:@%/-]+$')
      - not matrix_web_assets_url_path.startswith('/_matrix')
      - not matrix_web_assets_url_path.startswith('/_synapse')
      - not (matrix_web_assets_url_path == '/admin' or matrix_web_assets_url_path.startswith('/admin/'))
      - not matrix_web_assets_url_path.startswith('/.well-known')
    fail_msg: >-
      matrix_web_assets_url_path must be a safe absolute path and must not overlap
      reserved routes (/_matrix, /_synapse, /admin, /.well-known).

- name: Validate controller assets sync settings
  ansible.builtin.assert:
    that:
      - matrix_web_assets_local_path | string | length > 0
    fail_msg: "matrix_web_assets_local_path must be a non-empty path."
  when: matrix_web_assets_sync_from_controller | bool

- name: Validate Synapse Admin upstream port
  ansible.builtin.assert:
    that:
      - synapse_admin_upstream_port | int > 0
      - synapse_admin_upstream_port | int < 65536
    fail_msg: "synapse_admin_upstream_port must be between 1 and 65535."

- name: Validate Element Classic upstream port
  ansible.builtin.assert:
    that:
      - element_classic_upstream_port | int > 0
      - element_classic_upstream_port | int < 65536
    fail_msg: "element_classic_upstream_port must be between 1 and 65535."

- name: Validate Synapse Admin restrict base URL format
  ansible.builtin.assert:
    that:
      - synapse_admin_restrict_baseurl | string | length > 0
      - synapse_admin_restrict_baseurl is match('^https?://')
    fail_msg: "synapse_admin_restrict_baseurl must start with http:// or https://."

- name: Validate Synapse Admin config object type
  ansible.builtin.assert:
    that:
      - synapse_admin_config_json is mapping
    fail_msg: "synapse_admin_config_json must be a YAML object (mapping)."

- name: Validate Element Classic config object type
  ansible.builtin.assert:
    that:
      - element_classic_config_json is mapping
    fail_msg: "element_classic_config_json must be a YAML object (mapping)."

- name: Validate Element Classic branding logo file name
  ansible.builtin.assert:
    that:
      - element_classic_branding_logo_file | trim | length == 0 or element_classic_branding_logo_file is match('^[^/].*')
      - element_classic_branding_logo_file | trim | length == 0 or ('..' not in element_classic_branding_logo_file)
    fail_msg: >-
      element_classic_branding_logo_file must be empty or a relative filename/path
      within matrix_web_assets_host_path (no leading '/' and no '..').

- name: Validate Element Classic branding background file name
  ansible.builtin.assert:
    that:
      - element_classic_branding_background_file | trim | length == 0 or element_classic_branding_background_file is match('^[^/].*')
      - element_classic_branding_background_file | trim | length == 0 or ('..' not in element_classic_branding_background_file)
    fail_msg: >-
      element_classic_branding_background_file must be empty or a relative filename/path
      within matrix_web_assets_host_path (no leading '/' and no '..').

- name: Validate Element Classic custom welcome file name
  ansible.builtin.assert:
    that:
      - element_classic_custom_welcome_file | trim | length > 0
      - element_classic_custom_welcome_file is match('^[^/].*')
      - (".." not in element_classic_custom_welcome_file)
    fail_msg: >-
      element_classic_custom_welcome_file must be a relative filename/path
      within matrix_web_assets_host_path (no leading '/' and no '..').
  when: element_classic_custom_welcome_enabled | bool

- name: Validate Element Classic custom welcome locale format
  ansible.builtin.assert:
    that:
      - element_classic_custom_welcome_locale | trim | length > 0
      - element_classic_custom_welcome_locale is match('^[A-Za-z]{2,3}(-[A-Za-z0-9]{2,8})*$')
    fail_msg: >-
      element_classic_custom_welcome_locale must be a valid locale code,
      for example pt-BR.
  when: element_classic_custom_welcome_enabled | bool

- name: Validate Synapse Admin well-known homeserver format
  ansible.builtin.assert:
    that:
      - synapse_admin_well_known_homeserver | string | length > 0
      - synapse_admin_well_known_homeserver is match('^https?://')
    fail_msg: "synapse_admin_well_known_homeserver must start with http:// or https://."
