---
- name: Ensure secrets directory exists
  ansible.builtin.file:
    path: "{{ matrix_home }}/.secrets"
    state: directory
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0700"

- name: Persist provided synapse macaroon secret key
  ansible.builtin.copy:
    dest: "{{ matrix_home }}/.secrets/macaroon_secret_key"
    content: "{{ synapse_macaroon_secret_key }}"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0600"
  when: synapse_macaroon_secret_key is defined and synapse_macaroon_secret_key | string | length > 0
  no_log: true

- name: Generate synapse macaroon secret key if missing
  ansible.builtin.command: "openssl rand -hex 32"
  register: macaroon_gen
  args:
    creates: "{{ matrix_home }}/.secrets/macaroon_secret_key"
  changed_when: macaroon_gen.rc == 0
  when: synapse_macaroon_secret_key is not defined or synapse_macaroon_secret_key | string | length == 0
  no_log: true

- name: Persist generated synapse macaroon secret key
  ansible.builtin.copy:
    dest: "{{ matrix_home }}/.secrets/macaroon_secret_key"
    content: "{{ macaroon_gen.stdout }}"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0600"
  when: macaroon_gen is changed
  no_log: true

- name: Persist provided registration shared secret
  ansible.builtin.copy:
    dest: "{{ matrix_home }}/.secrets/registration_shared_secret"
    content: "{{ synapse_registration_shared_secret }}"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0600"
  when: synapse_registration_shared_secret is defined and synapse_registration_shared_secret | string | length > 0
  no_log: true

- name: Generate registration shared secret if missing
  ansible.builtin.command: "openssl rand -hex 32"
  register: reg_gen
  args:
    creates: "{{ matrix_home }}/.secrets/registration_shared_secret"
  changed_when: reg_gen.rc == 0
  when: synapse_registration_shared_secret is not defined or synapse_registration_shared_secret | string | length == 0
  no_log: true

- name: Persist generated registration shared secret
  ansible.builtin.copy:
    dest: "{{ matrix_home }}/.secrets/registration_shared_secret"
    content: "{{ reg_gen.stdout }}"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0600"
  when: reg_gen is changed
  no_log: true

- name: Load synapse macaroon secret key
  ansible.builtin.slurp:
    src: "{{ matrix_home }}/.secrets/macaroon_secret_key"
  register: macaroon_secret_raw
  no_log: true

- name: Load synapse registration shared secret
  ansible.builtin.slurp:
    src: "{{ matrix_home }}/.secrets/registration_shared_secret"
  register: registration_secret_raw
  no_log: true

- name: Set synapse secret facts
  ansible.builtin.set_fact:
    synapse_macaroon_secret_key: "{{ macaroon_secret_raw.content | b64decode | trim }}"
    synapse_registration_shared_secret: "{{ registration_secret_raw.content | b64decode | trim }}"
  no_log: true

- name: Parse backup time
  ansible.builtin.set_fact:
    backup_cron_hour: "{{ (backup_time.split(':'))[0] }}"
    backup_cron_minute: "{{ (backup_time.split(':'))[1] }}"

- name: Check controller web assets directory
  ansible.builtin.stat:
    path: "{{ matrix_web_assets_local_path }}"
  register: matrix_web_assets_local_dir
  delegate_to: localhost
  become: false
  when: matrix_web_assets_sync_from_controller | bool

- name: Copy controller web assets to managed host
  ansible.builtin.copy:
    src: "{{ matrix_web_assets_local_path }}/"
    dest: "{{ matrix_web_assets_host_path }}/"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
    directory_mode: "0755"
  when:
    - matrix_web_assets_sync_from_controller | bool
    - matrix_web_assets_local_dir.stat.exists | default(false)
    - matrix_web_assets_local_dir.stat.isdir | default(false)

- name: Find web asset subdirectories
  ansible.builtin.find:
    paths: "{{ matrix_web_assets_host_path }}"
    file_type: directory
    recurse: true
  register: matrix_web_assets_dirs

- name: Ensure web asset subdirectories are traversable
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0755"
  loop: "{{ matrix_web_assets_dirs.files }}"

- name: Find web asset files
  ansible.builtin.find:
    paths: "{{ matrix_web_assets_host_path }}"
    file_type: file
    recurse: true
  register: matrix_web_assets_files

- name: Ensure web asset files are readable
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: file
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
  loop: "{{ matrix_web_assets_files.files }}"

- name: Check Element Classic branding logo file
  ansible.builtin.stat:
    path: "{{ matrix_web_assets_host_path }}/{{ element_classic_branding_logo_file }}"
  register: element_classic_branding_logo_stat
  when: element_classic_branding_logo_file | trim | length > 0

- name: Assert Element Classic branding logo file exists
  ansible.builtin.assert:
    that:
      - element_classic_branding_logo_stat.stat.exists
      - element_classic_branding_logo_stat.stat.isreg
    fail_msg: >-
      element_classic_branding_logo_file points to
      {{ matrix_web_assets_host_path }}/{{ element_classic_branding_logo_file }},
      but that file does not exist on the managed host.
  when: element_classic_branding_logo_file | trim | length > 0

- name: Check Element Classic branding background file
  ansible.builtin.stat:
    path: "{{ matrix_web_assets_host_path }}/{{ element_classic_branding_background_file }}"
  register: element_classic_branding_background_stat
  when: element_classic_branding_background_file | trim | length > 0

- name: Assert Element Classic branding background file exists
  ansible.builtin.assert:
    that:
      - element_classic_branding_background_stat.stat.exists
      - element_classic_branding_background_stat.stat.isreg
    fail_msg: >-
      element_classic_branding_background_file points to
      {{ matrix_web_assets_host_path }}/{{ element_classic_branding_background_file }},
      but that file does not exist on the managed host.
  when: element_classic_branding_background_file | trim | length > 0

- name: Render environment file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ matrix_home }}/.env"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0600"
  no_log: true

- name: Render Synapse config
  ansible.builtin.template:
    src: homeserver.yaml.j2
    dest: "{{ matrix_home }}/homeserver.yaml"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0640"
  no_log: true

- name: Render Synapse runtime config in data directory
  ansible.builtin.template:
    src: homeserver.yaml.j2
    dest: "{{ matrix_data_dir }}/synapse/homeserver.yaml"
    owner: "{{ synapse_host_uid }}"
    group: "{{ synapse_host_gid }}"
    mode: "0640"
  no_log: true

- name: Render Synapse logging config in data directory
  ansible.builtin.template:
    src: synapse.log.config.j2
    dest: "{{ matrix_data_dir }}/synapse/log.config"
    owner: "{{ synapse_host_uid }}"
    group: "{{ synapse_host_gid }}"
    mode: "0644"

- name: Render nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ matrix_home }}/nginx/nginx.conf"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
  register: nginx_config_render

- name: Render Synapse Admin config
  ansible.builtin.template:
    src: synapse-admin.config.json.j2
    dest: "{{ matrix_home }}/synapse-admin/config.json"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"

- name: Render Cinny config
  ansible.builtin.template:
    src: cinny.config.json.j2
    dest: "{{ matrix_home }}/cinny/config.json"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
  when: matrix_web_default_client_normalized == 'cinny' or matrix_web_secondary_client_normalized == 'cinny'

- name: Render Element Classic config
  ansible.builtin.template:
    src: element-classic.config.json.j2
    dest: "{{ matrix_home }}/element-classic/config.json"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"
  when: matrix_web_default_client_normalized == 'element_classic' or matrix_web_secondary_client_normalized == 'element_classic'

- name: Render docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ matrix_home }}/docker-compose.yml"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"

- name: Render backup Dockerfile
  ansible.builtin.template:
    src: backup.Dockerfile.j2
    dest: "{{ matrix_home }}/backup/Dockerfile"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"

- name: Render backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: "{{ matrix_home }}/backup/backup.sh"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0750"

- name: Render backup crontab
  ansible.builtin.template:
    src: backup.crontab.j2
    dest: "{{ matrix_home }}/backup/crontab"
    owner: "{{ matrix_user }}"
    group: "{{ matrix_user }}"
    mode: "0644"

- name: Deploy reset script
  ansible.builtin.template:
    src: reset-matrix.sh.j2
    dest: "{{ matrix_reset_script_path }}"
    owner: root
    group: root
    mode: "0750"
  when: matrix_reset_script_enabled | bool
