---
- name: Ensure Synapse signing key exists
  ansible.builtin.command: >-
    docker run --rm
    -v {{ matrix_data_dir }}/synapse:/data
    -e SYNAPSE_SERVER_NAME={{ matrix_fqdn }}
    -e SYNAPSE_REPORT_STATS=no
    {{ synapse_image }} generate
  args:
    creates: "{{ matrix_data_dir }}/synapse/{{ matrix_fqdn }}.signing.key"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Check backup image
  ansible.builtin.command: docker image inspect {{ backup_image_local }}
  register: backup_image_check
  failed_when: false
  changed_when: false
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Build backup image if missing
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    build backup
  when: backup_image_check.rc != 0
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Check Synapse Admin image
  ansible.builtin.command: docker image inspect {{ synapse_admin_image }}
  register: synapse_admin_image_check
  failed_when: false
  changed_when: false
  when:
    - synapse_admin_build_enabled | bool
    - synapse_admin_image | trim | length > 0
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Build Synapse Admin image if missing
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    build synapse-admin
  when:
    - synapse_admin_build_enabled | bool
    - synapse_admin_image | trim | length == 0 or synapse_admin_image_check.rc != 0
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Start matrix stack
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    up -d --remove-orphans
  changed_when: false
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Check nginx published port
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    port nginx 80
  register: nginx_port
  failed_when: false
  changed_when: false
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Recreate nginx if port publishing is missing
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    up -d --force-recreate nginx
  when: >-
    nginx_config_render is changed
    or nginx_port.rc != 0
    or (nginx_port.stdout | trim | regex_search('8080$')) is none
  changed_when: false
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Verify nginx published port
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    port nginx 80
  register: nginx_port_verified
  failed_when: false
  changed_when: false
  args:
    chdir: "{{ matrix_home }}"
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Assert nginx is bound to port 8080
  ansible.builtin.assert:
    that:
      - nginx_port_verified.rc == 0
      - (nginx_port_verified.stdout | trim | regex_search('8080$')) is not none
    fail_msg: >-
      nginx is not publishing port 8080 from Docker Compose
      (rc={{ nginx_port_verified.rc }}, stdout='{{ nginx_port_verified.stdout | default('') | trim }}',
      stderr='{{ nginx_port_verified.stderr | default('') | trim }}').

- name: Wait for Element Classic to respond through nginx
  ansible.builtin.uri:
    url: "http://127.0.0.1:8080/"
    method: GET
    status_code: 200
  register: element_classic_health
  retries: 20
  delay: 6
  until: element_classic_health.status == 200

- name: Wait for Synapse to respond
  ansible.builtin.uri:
    url: http://127.0.0.1:8080/_matrix/client/versions
    method: GET
    status_code: 200
  register: synapse_health
  retries: 20
  delay: 6
  until: synapse_health.status == 200

- name: Wait for Matrix client well-known endpoint
  ansible.builtin.uri:
    url: http://127.0.0.1:8080/.well-known/matrix/client
    method: GET
    status_code: 200
    return_content: true
  register: matrix_client_well_known
  retries: 20
  delay: 6
  until: matrix_client_well_known.status == 200

- name: Assert Matrix client well-known includes Synapse Admin homeserver hint
  ansible.builtin.assert:
    that:
      - matrix_client_well_known.json['io.famedly.login'] is defined
      - matrix_client_well_known.json['io.famedly.login']['homeserver'] == synapse_admin_well_known_homeserver
    fail_msg: >-
      /.well-known/matrix/client does not expose io.famedly.login.homeserver as expected
      (expected='{{ synapse_admin_well_known_homeserver }}',
      got='{{ matrix_client_well_known.json['io.famedly.login']['homeserver'] | default('') }}').

- name: Check if admin user exists
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    exec -T postgres
    psql -U {{ postgres_user }} -d {{ postgres_db }} -tAc
    "SELECT 1 FROM users WHERE name='@{{ matrix_admin_user }}:{{ matrix_fqdn }}';"
  register: admin_exists
  changed_when: false
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"

- name: Create admin user if missing
  ansible.builtin.command: >-
    docker compose
    -f {{ matrix_home }}/docker-compose.yml
    -p {{ docker_compose_project }}
    exec -T synapse
    register_new_matrix_user
    -c /data/homeserver.yaml
    -u "{{ matrix_admin_user }}"
    -p "{{ matrix_admin_password }}"
    -a
  when: admin_exists.stdout | trim == ""
  no_log: true
  become: true
  become_user: "{{ matrix_user }}"
  environment:
    DOCKER_HOST: "unix:///run/user/{{ matrix_uid }}/docker.sock"
    XDG_RUNTIME_DIR: "/run/user/{{ matrix_uid }}"
    HOME: "{{ matrix_home }}"
