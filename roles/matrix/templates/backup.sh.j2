#!/usr/bin/env bash
set -euo pipefail

TS="$(date +%Y%m%d-%H%M%S)"
BACKUP_ROOT=/backups
DB_DIR="${BACKUP_ROOT}/db"
MEDIA_DIR="${BACKUP_ROOT}/media"
RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-14}"

mkdir -p "${DB_DIR}" "${MEDIA_DIR}"

# Database backup
pg_dump -h postgres -U "{{ postgres_user }}" "{{ postgres_db }}" > "${DB_DIR}/synapse-${TS}.sql"

# Media store backup (incremental via rsync)
rsync -a --delete /data/media_store/ "${MEDIA_DIR}/current/"

tar -czf "${MEDIA_DIR}/media-${TS}.tar.gz" -C "${MEDIA_DIR}" current

# Retention
find "${DB_DIR}" -type f -name 'synapse-*.sql' -mtime +"${RETENTION_DAYS}" -delete
find "${MEDIA_DIR}" -type f -name 'media-*.tar.gz' -mtime +"${RETENTION_DAYS}" -delete
