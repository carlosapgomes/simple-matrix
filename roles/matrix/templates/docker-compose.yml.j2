services:
  postgres:
    image: {{ postgres_image }}
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_INITDB_ARGS: "{{ postgres_initdb_args }}"
    volumes:
      - "{{ matrix_data_dir }}/postgres:/var/lib/postgresql/data"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\" -h 127.0.0.1",
        ]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 10s
    restart: unless-stopped
    networks:
      - matrix_net

  synapse:
    image: {{ synapse_image }}
    user: "{{ synapse_container_user }}"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SYNAPSE_CONFIG_PATH: /data/homeserver.yaml
    volumes:
      - "{{ matrix_data_dir }}/synapse:/data"
      - "{{ matrix_data_dir }}/media_store:/data/media_store"
    restart: unless-stopped
    networks:
      - matrix_net

  synapse-admin:
    image: {{ synapse_admin_image }}
    environment:
      REACT_APP_SERVER: "https://{{ matrix_fqdn }}"
      REACT_APP_SERVER_NAME: "{{ matrix_instance_name }}"
    restart: unless-stopped
    networks:
      - matrix_net

  cinny:
    image: {{ cinny_image }}
{% if cinny_build_from_source | bool %}
    build:
      context: ./cinny/src
{% endif %}
    volumes:
      - "{{ matrix_home }}/cinny/config.json:/usr/share/nginx/html/config.json:ro"
      - "{{ matrix_home }}/cinny/custom:/usr/share/nginx/html/custom:ro"
    restart: unless-stopped
    networks:
      - matrix_net

  nginx:
    image: {{ nginx_image }}
    depends_on:
      - synapse
      - synapse-admin
      - cinny
    ports:
      - "8080:80"
    volumes:
      - "{{ matrix_home }}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
    restart: unless-stopped
    networks:
      - matrix_net

  backup:
    image: {{ backup_image_local }}
    build:
      context: ./backup
    environment:
      BACKUP_RETENTION_DAYS: "{{ backup_retention_days }}"
      PGPASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - "{{ matrix_backup_dir }}:/backups"
      - "{{ matrix_data_dir }}:/data:ro"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - matrix_net

networks:
  matrix_net:
    internal: true
